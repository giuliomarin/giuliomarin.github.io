<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>I and G wedding | About us</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/wedding/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/wedding/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/wedding/favicon/favicon-16x16.png">
  <link rel="manifest" href="/wedding/favicon/site.webmanifest">
  <link rel="mask-icon" href="/wedding/favicon/safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="/wedding/favicon/favicon.ico">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-config" content="/wedding/favicon/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" type="text/css" href="./style.css" />

  <link href="//fonts.googleapis.com/css?family=Dosis:400,700%7CBitter:400,400italic,700&subset=latin,latin" rel="stylesheet" type="text/css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>

  <!-- Map -->
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.47.0/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.47.0/mapbox-gl.css' rel='stylesheet' />
  <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v2.0.0/turf.min.js' charset='utf-8'></script>
  <script src='csv2geojson.js'></script>
  <style>
  #map { display:block; position:relative; top: 10px; height: 400px; width:100%; }
  .session { position:relative; margin-top: 0px; margin-left: 10px; margin-right: 10px}
  #slider {width:100%}
  .container { display: flex; justify-content: space-between; }
  </style>

  <script>
  $(function(){
    $("#my-footer").load("./footer.html");
  });

  $(document).ready(function(){
    $("html").attr("lang", navigator.language || navigator.userLanguage);
  });
  </script>
</head>

<body class="sidebar">
  <div id="topbar" role="banner">
    <a class="logo icon-btn" href="index.html">
      <i class="icon-home"></i>
    </a>

    <ul class="inline-list title">
      <li><a class="btn plain" href="about.html"><i class="icon-tv" title="About us"></i>About us</a></li>
      <li><a class="btn plain" href="hotel.html"><i class="icon-newspaper" title="Hotel"></i>Hotel</a></li>
      <li><a class="btn plain" href="engagement.html"><i class="icon-camera" title="Photos"></i>Photos</a></li>
      <li><a class="btn plain" href="activities.html"><i class="icon-pitch" title="Activities"></i>Activities</a></li>
      <li><a class="btn plain" href="rsvp.html"><i class="icon-pencil" title="RSVP"></i>RSVP</a></li>
      <li><a class="btn plain" href="registry.html"><i class="icon-list-bullet" title="Registry"></i>Registry</a></li>
    </ul>

    <a class="icon-btn nav-trigger" href="#nav">
      <i class="icon-menu"></i>
    </a>
  </div>

  <section id="page" class="post" role="main">

    <header class="wrap post-header">
      <h1 class="page-title">About us</h1>
    </header>

    <hr/>

    <article class="wrap post-content">
      <h4 class="en"> Our story </h4>
      <h4 class="it"> La nostra storia </h4>
      <h6> His version </h6>
      <p>I first heard about Ilene when her dad, Abbas, put me in contact with her when I was looking for an apartment in the summer of 2013, when I moved to the Bay Area for an internship...at her dad's startup! Very kind of him, but also very frustrating for me that then I was stuck with a dilemma. Should I accept the offer and go live with my boss' daughter? That sounds weird! But if he is asking, maybe I should go? The tone of the email made it clear that he didn't want us to have much interaction, only email allowed! The email said <em>"Hi Giulio and Ilene, I wanted to introduce you to each other. You can exchange email if you want more information about the rental"</em>. I ended up renting another place for the summer but the next year I got a full time offer and again I was looking for an accommodation. So I asked my boss if I could check with his daughter: <em>"You can send her an email and find out in case she is away during that time"</em>. We exchanged some emails in the next few months and I also gave her my number but again only email. Eventually it didn't work out and I found another place.<br>
      I started wondering whether she was real or not. One day Abbas invited some people over for dinner after work and finally Ilene became a real person. She was wearing a sweatshirt 2 or 3 sizes bigger than her but I thought she was cute. I don't think we exchanged a single word that night though.<br>
      Time for company holiday party and my RSVP for for myself only. After receiving several complains from the office manager because I was not bringing a date I started thinking who I should have asked. I heard that Abbas was coming with the the entire family so I thought I would ask one of the two daughters to be my date. One already had a boyfriend so I asked permission to Abbas and sent Ilene an email. She accepted to be my +1 but still no phone number so we had to arrange the date over email. We ended up going to the dinner together but never talked. I was waiting to get some time with her alone so we could talk, given all the pressure that my fellow Italian coworkers were putting on me. But when her parents left and made sure I would send her home, soon she came up with a vague excuse and quickly left with her sister. Anyway she finally texted me after the dinner so at least I had her number. We exchanged a few messages and we decided to go out for drinks on Christmas Eve. We went to a bar and "by chance" her sister was also there! Anyway we ended up talking all night, despite the monitoring on the back. I think that night was our actual first date.
      </p>

      <h6> Her version </h6>
      <p>In 2014, my dad had hired a computer vision intern from the University of Padova for a summer internship to join his R&D group. Naturally, my highly protective dad volunteered my apartment as a place to house this stranger and recommended he get in touch with me to be my roommate. My first interaction with Giulio was therefore via email. At that time I already had a roommate so I told him to check again after a few months. Undeterred Giulio emailed me after some time trying to be my roommate again, but the stars didn’t align that time either. Would things have turned out differently had Giulio been my roommate? Would each of our pragmatic sides (and the fact that it is NEVER a good idea to date your roommate) have won out, or would love have found a way? Who knows...<br>
      Giulio and I eventually met in person a few weeks later, when my dad invited some engineers over for dinner. I don’t think we talked but I guess I made an impression! A few months after, as 2014 drew to a close, Giulio turned to the advisor who had also supplied him with a potential roommate (my dad) and asked him if I had a date to the holiday party.
      My dad knew I was free since I’d originally agreed to accompany him and my entire family to the party (good looking out, Dad!) I received an email from Giulio inviting me to the holiday party, which I happily accepted. After all, who would pass up the opportunity to go on a first date accompanied by one's entire family? :P<br>
      At the holiday party, Giulio and I didn’t talk to one another much, but I do remember that he made a judgmental comment when I added pineapple to my salad at the dinner buffet. (I know now that mixing food is a very grave mistake to Italians, because pineapple should only be eaten by itself, as a dessert, not with salad and especially not on pizza.) Later, to avoid any awkward end-of-night goodbyes, I made up an excuse that I needed to go home with Lily because she had my keys, profusely apologized to Giulio for my forgetfulness, and we called it a night.<br>
      On Christmas Eve, I agreed to a second date with Giulio. Unbeknownst to him, Lily was getting drinks at a bar in Palo Alto, and I casually suggested to Giulio that we meet at the same bar she was at. When we strolled in together, I feigned surprise at seeing her sitting there. Giulio was probably less than thrilled, but I distinctly remember being relieved to find out that he actually talked, and furthermore, that we had a lot to talk about.
      Our dates went smoother from there and we quickly got comfortable with each other - I only subjected Giulio to 2 more family-supervised dates after that…and the rest is history :)<br>
      Fun fact - my dad, despite being the one who ostensibly set us up, was unaware that Giulio had romantic intentions when he asked me to the holiday party. Somehow (the engineer is strong in him) he ended up being one of the last people at the company to know we were dating!</p>

      <figure class="photo my-gallery column">
        <img src="./images/IMG_3416.jpg" data-src="./images/IMG_3416.jpg"/>
        <figcaption>Christmas Eve 2014</figcaption>
      </figure>

      <hr>
      <h4 class="en"> Troubles with our names? </h4>
      <h4 class="it"> Problemi con la pronuncia? </h4>
      <p class="en">Click here to hear how to pronounce our names.</p>
      <p class="it">Clicca qui per sentire come pronunciare i nostri nomi.</p>
      <h6> Ilène?! Iléne?! Ilęne?! </h6>
      <audio src="ilene.m4a" autostart="0" controls></audio>
      <h6> Julio?! Guilio?! Guilian?! </h6>
      <audio src="giulio.m4a" autostart="0" controls></audio>

      <hr>

      <h4 class="en"> How many miles have we traveled since we met? </h4>
      <h4 class="it"> Quanti chilometri abbiamo percorso da quando ci conosciamo? </h4>
      <div class='session' id='sliderbar'>
        <div class='container'>
          <div id='giulio-dist' style="font-family: monospace; color: #0071FF; margin-left: 10%">1989</div>
          <div id='active-date' style="font-family: monospace">1989</div>
          <div id='ilene-dist' style="font-family: monospace; color: #CC719B; margin-right: 10%">1989</div>
        </div>
        <input id='slider' class='row' type='range' min='1989' max='2019.58' step='0.01' value='1989'/>
      </div>
      <div class='session'>
        <div class='row' id='filters' style="display: none">
          <input id='both' type='radio' name='toggle' value='both' checked='checked'>
          <label for='both'>both</label>
          <input id='ilene' type='radio' name='toggle' value='ilene'>
          <label for='ilene'>ilene</label>
          <input id='giulio' type='radio' name='toggle' value='giulio'>
          <label for='giulio'>giulio</label>
        </div>
      </div>
      <div id="map" class="photo"></div>
    </article>

  </article>
</section>

<hr>

<div id="my-footer"></div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZGFuc3dpY2siLCJhIjoiY2l1dTUzcmgxMDJ0djJ0b2VhY2sxNXBiMyJ9.25Qs4HNEkHubd4_Awbd8Og';
var big, zoom, center;
if (window.innerWidth <= 800) {
  center = [ -50, 40]
  zoom = 0;
  big = false;
  document.getElementById("map").style.height = "200px"
} else {
  center = [ -50, 40]
  zoom = 0.5;
  big = true;
}
var map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/streets-v8',
  center: center,
  zoom: zoom,
  // renderWorldCopies: false
});

// DEBUG: To show coordinates of mouse click
// map.on('click', function (e) {console.log(e), console.log("%s,%s", e.lngLat.lat, e.lngLat.lng)});

var filterPerson = ['!=', ['string', ['get', 'person']], 'placeholder'];
var filterDate = ['>=', ['number', ['to-number', ['get', 'datef']]], 1989];

const numSegments = 40
const percSegmentsHistory = 0.4

// A simple line from origin to destination.
var route = {
  "type": "FeatureCollection",
  "features": [{
    "type": "Feature",
    "geometry": {
      "type": "LineString",
      "coordinates": []
    },
    "properties": {
      "person": "giulio"
    }
  },
  {
    "type": "Feature",
    "geometry": {
      "type": "LineString",
      "coordinates": []
    },
    "properties": {
      "person": "ilene"
    }
  }]
};

function computeTravel(data)
{
  var travel = {'coordinates': [], 'dates': [], 'distance': [], 'totdistance': [], 'step': []}
  var trip = {
    "type": "FeatureCollection",
    "features": [{
      "type": "Feature",
      "geometry": {
        "type": "LineString",
        "coordinates": []
      }
    }]
  };

  for (var i = 0; i < data.length - 1; i++)
  {
    var delta = data[i + 1].datef - data[i].datef
    if (delta <= 0) continue

    // Draw an arc between the origin and destination of the two points
    trip.features[0].geometry.coordinates = [data[i].coordinates, data[i+1].coordinates]
    var lineDistance = turf.lineDistance(trip.features[0], 'kilometers');
    const segmentLength = lineDistance / numSegments
    // const numSegments = lineDistance / segmentLength;
    const stepDate = delta / numSegments;
    // TODO: maybe the segment does not contain the end
    for (var j = 0; j <= numSegments; j ++) {
      travel.step.push(j)
      travel.dates.push(data[i].datef + stepDate * j)
      travel.distance.push(segmentLength)
      travel.totdistance.push(lineDistance)
      var segment = turf.along(trip.features[0], j * segmentLength, 'kilometers');
      var coords = segment.geometry.coordinates;
      coords[0] = (coords[0] < -180) ? coords[0] + 360 : coords[0];
      coords[0] = (coords[0] > 180) ? coords[0] - 360 : coords[0];
      coords[1] = (coords[1] < -180) ? coords[1] + 360 : coords[1];
      coords[1] = (coords[1] > 180) ? coords[1] - 360 : coords[1];
      travel.coordinates.push(coords);
    }
  }
  return travel;
}

function getTrip(travel, y)
{
  var x2 = 0
  for (var i in travel.coordinates)
  {
    x2 = +i
    if (travel.dates[i] > y) break
  }
  var x1 = x2 - Math.min(travel.step[x2], percSegmentsHistory * numSegments)
  return travel.coordinates.slice(x1, x2)
}

function getTrip2(travel, x2)
{
  var x1 = x2 - Math.min(travel.step[x2], percSegmentsHistory * numSegments)
  return travel.coordinates.slice(x1, x2)
}

function norm(x, y)
{
  return Math.sqrt((x[0] - y[0]) * (x[0] - y[0]) + (x[1] - y[1]) * (x[1] - y[1]))
}

function fixDateLine(route)
{
  var routeOut = jQuery.extend(true, {}, route);
  for (var i = 0; i < routeOut.features.length; i++)
  {
    var coords = routeOut.features[i].geometry.coordinates
    for (var j = 1; j < coords.length; j++)
    {
      if (norm(coords[j], coords[j - 1]) > 90)
      {
        // TODO: improve coordinate at 180
        var split = jQuery.extend(true, {}, routeOut.features[i]);
        split.geometry.coordinates = routeOut.features[i].geometry.coordinates.slice(j)
        routeOut.features[i].geometry.coordinates = routeOut.features[i].geometry.coordinates.slice(0, j)
        if (coords[j-1][0] > 0) {
          routeOut.features[i].geometry.coordinates[j - 1][0] = 180.
          split.geometry.coordinates[0][0] = -180.
        }
        else {
          routeOut.features[i].geometry.coordinates[j - 1][0] = -180.
          split.geometry.coordinates[0][0] = 180.
        }
        routeOut.features.push(split)
        break
      }
    }
  }
  return routeOut
}

$(document).ready(function() {
  $.ajax({
    type: "GET",
    url: './places.csv',
    dataType: "text",
    success: function(csvData) {makeGeoJSON(csvData);}
  });
});

var slider = document.getElementById("slider");

var travel_giulio;
var travel_ilene;

function toFixed(value, precision) {
  var power = Math.pow(10, precision || 0);
  return String(Math.round(value * power) / power);
}

function getDist(d)
{
  // Convert to miles
  var unit = 'km'
  if (document.documentElement.lang.startsWith("en")) {
    d *= 0.62
    unit = 'mi'
  }

  var str = ''
  if (d < 1000) str += toFixed(d, 0)
  else if (d < 1000000) str += toFixed(d / 1000, 0) + 'K'
  else if (d < 1000000000) str += toFixed(d / 1000000, 2) + 'M'
  else str += toFixed(d, 0)
  str += ' ' + unit
  return str
}

function makeGeoJSON(csvData) {
  csv2geojson.csv2geojson(csvData, {
    latfield: 'latitude',
    lonfield: 'longitude',
    delimiter: ','
  }, function(err, data) {

    // Read data
    var data_giulio = []
    var data_ilene = []
    var dates = []
    // Sort by date
    data.features.sort(function(a, b) {return a.properties.datef - b.properties.datef;});
    data.features.forEach(function(f) {dates.push(f.properties.date)})
    dates = dates.sort().filter(function(elem, index, self) { return index == self.indexOf(elem);});
    for (var i in data.features)
    {
      if (data.features[i].properties.person == 'giulio') {data_giulio.push(data.features[i])}
      else if (data.features[i].properties.person == 'ilene') {data_ilene.push(data.features[i])}
    }
    data_giulio.push(jQuery.extend(true, {}, data_giulio[data_giulio.length - 1]))
    data_giulio[data_giulio.length - 1].properties.datef = parseFloat(slider.max)
    data_ilene.push(jQuery.extend(true, {}, data_ilene[data_ilene.length - 1]))
    data_ilene[data_ilene.length - 1].properties.datef = parseFloat(slider.max)

    // Add events to match date
    var g = 0, i = 0;
    for (i in dates)
    {
      if (data_giulio[i].properties.date != dates[i])
      {
        var e = jQuery.extend(true, {}, data_giulio[Math.max(0, i - 1)]);
        e.properties.date = dates[i]
        e.properties.datef = csv2geojson.date2float(dates[i])
        data_giulio.splice(i, 0, e);
      }
      if (data_ilene[i].properties.date != dates[i])
      {
        var e = jQuery.extend(true, {}, data_ilene[Math.max(0, i - 1)]);
        e.properties.date = dates[i]
        e.properties.datef = csv2geojson.date2float(dates[i])
        data_ilene.splice(i, 0, e);
      }
    }

    data.features = []
    data_giulio.forEach(function(f) {data.features.push(f)})
    data_ilene.forEach(function(f) {data.features.push(f)})

    var data_giulio_travel = []
    var data_ilene_travel = []
    data_giulio.forEach(function(f) {var e = {'coordinates': f.geometry.coordinates, 'datef': f.properties.datef, 'name': f.properties.name}; data_giulio_travel.push(e)})
    data_ilene.forEach(function(f) {var e = {'coordinates': f.geometry.coordinates, 'datef': f.properties.datef, 'name': f.properties.name}; data_ilene_travel.push(e)})

    // Compute trajectory
    travel_giulio = computeTravel(data_giulio_travel)
    travel_ilene = computeTravel(data_ilene_travel)

    map.on('load', function () {
      map.addSource('route', {
        "type": "geojson",
        "data": route
      });
      map.addLayer({
        "id": "route",
        "source": "route",
        "type": "line",
        "paint": {
          "line-width": 3,
          "line-opacity": 0.8,
          "line-color":
          ['match', ['get', 'person'],
          "giulio", '#0071FF',
          'ilene', '#CC719B',
          '#AAAAAA']
        }
      });
      map.addSource('data', { type: 'geojson', data: data });
      map.addLayer({
        'id': 'places',
        'type': 'circle',
        'source': 'data',
        'paint': {
          'circle-radius': {
            'base': 5,
            'stops': [[1, 10], [10, 10]]
          },
          'circle-blur': 1,
          'circle-color':
          ['match', ['get', 'person'],
          "giulio", '#0071FF',
          'ilene', '#CC719B',
          '#AAAAAA']
        },
        filter: ['all', filterDate, filterPerson]
      });

      var counter = 0
      while (travel_giulio.dates[counter] < 2014) counter++;
      var dist_giulio = 0, dist_ilene = 0;
      function animate() {
        route.features = route.features.splice(0, 2)
        route.features[0].geometry.coordinates = getTrip2(travel_giulio, counter)
        route.features[1].geometry.coordinates = getTrip2(travel_ilene, counter)
        route = fixDateLine(route)
        map.getSource('route').setData(route);

        dist_giulio += travel_giulio.distance[counter]
        dist_ilene += travel_ilene.distance[counter]
        document.getElementById('giulio-dist').innerText = getDist(dist_giulio);
        document.getElementById('ilene-dist').innerText = getDist(dist_ilene);

        slider.value = travel_giulio.dates[counter]
        slider.dispatchEvent(new Event('input'));

        if ((travel_giulio.distance[counter] == 0 && travel_giulio.totdistance[counter] != 0) || (travel_ilene.distance[counter] == 0 && travel_ilene.totdistance[counter] != 0))
        {
          setTimeout(function() {counter = counter + 1; requestAnimationFrame(animate)}, 500)
        }
        else
        {
          counter = counter + 1;
          if (counter >= travel_giulio.coordinates.length)
          {
            setTimeout(function() {dist_giulio = 0; dist_ilene = 0; counter = 0; requestAnimationFrame(animate)}, 5000)
          }
          else
          {
            requestAnimationFrame(animate);
          }
        }

      }
      animate()
    })

    slider.addEventListener('input', function(e) {
      var date = parseFloat(e.target.value) + 0.003;
      filterDate = ['<=', ['number', ['to-number', ['get', 'datef']]], date]
      map.setFilter('places', ['all', filterDate, filterPerson]);
      document.getElementById('active-date').innerText = date;
      const history = 0.05
      map.setPaintProperty('places', 'circle-opacity', ['*', 1.5, ['-', 1, ['/', ['-', date, ['number', ['to-number', ['get', 'datef']]]], history]]]);
    });

    document.getElementById('filters').addEventListener('change', function(e) {
      var person = e.target.value;
      if (person === 'both') {
        filterPerson = ['!=', ['string', ['get', 'person']], 'placeholder'];
      } else if (person === 'ilene') {
        filterPerson = ['match', ['get', 'person'], 'ilene', true, false];
      } else if (person === 'giulio') {
        filterPerson = ['match', ['get', 'person'], 'giulio', true, false];
      } else {
        console.log('person %s is not valid' % person);
      }
      map.setFilter('places', ['all', filterDate, filterPerson]);
      map.setFilter('route', filterPerson);
    });

    slider.addEventListener('input', function(e) {
      const y = parseInt(Math.floor(slider.value))
      const m = parseInt(Math.floor((slider.value % 1) * 365 / 31) + 1)
      document.getElementById('active-date').innerText = y + "/" + m;
    });

  });
}
</script>

</body>
</html>

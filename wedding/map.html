<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>I and G wedding | RSVP</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="apple-touch-icon" sizes="180x180" href="/wedding/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/wedding/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/wedding/favicon/favicon-16x16.png">
    <link rel="manifest" href="/wedding/favicon/site.webmanifest">
    <link rel="mask-icon" href="/wedding/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="/wedding/favicon/favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="/wedding/favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

    <link rel="stylesheet" type="text/css" href="./style.css" />

    <link href="//fonts.googleapis.com/css?family=Dosis:400,700%7CBitter:400,400italic,700&subset=latin,latin" rel="stylesheet" type="text/css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script>
      $(function(){
        $("#my-footer").load("./footer.html");
      });
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.47.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.47.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v2.0.0/turf.min.js' charset='utf-8'></script>
    <script src='csv2geojson.js'></script>
    <style>
    #map { display:block; position:relative; top: 10px; height: 400px; width:100%; }
    .session { position:relative; margin-top: 0px; margin-left: 10px; margin-right: 10px}
    #slider {width:100%}
    .container { display: flex; justify-content: space-between; }
    </style>
  </head>

  <body class="sidebar">
    <div id="topbar" role="banner">
    <a class="logo icon-btn" href="index.html">
      <i class="icon-home"></i>
    </a>

    <ul class="inline-list title">
      <li><a class="btn plain" href="about.html"><i class="icon-tv" title="About us"></i>About us</a></li>
      <li><a class="btn plain" href="hotel.html"><i class="icon-newspaper" title="Hotel"></i>Hotel</a></li>
      <li><a class="btn plain" href="engagement.html"><i class="icon-camera" title="Photos"></i>Photos</a></li>
      <li><a class="btn plain" href="activities.html"><i class="icon-pitch" title="Activities"></i>Activities</a></li>
      <li><a class="btn plain" href="rsvp.html"><i class="icon-pencil" title="RSVP"></i>RSVP</a></li>
      <li><a class="btn plain" href="registry.html"><i class="icon-list-bullet" title="Registry"></i>Registry</a></li>
    </ul>

      <a class="icon-btn nav-trigger" href="#nav">
        <i class="icon-menu"></i>
      </a>
    </div>

    <div id="page" role="main">
      <header class="wrap">
        <h1 class="page-title" >Flights</h1>
      </header>

      <hr>

      <article class="wrap post-content">
        <div class='session' id='sliderbar'>
          <div class='container'>
          <div id='giulio-dist' style="color: #0071FF; margin-left: 10%">1989</div>
          <div id='active-date'>1989</div>
          <div id='ilene-dist' style="color: #CC719B; margin-right: 10%">1989</div>
        </div>
          <input id='slider' class='row' type='range' min='1989' max='2020' step='0.01' value='1989'/>
        </div>
        <div class='session'>
          <div class='row' id='filters' style="display: none">
            <input id='both' type='radio' name='toggle' value='both' checked='checked'>
            <label for='both'>both</label>
            <input id='ilene' type='radio' name='toggle' value='ilene'>
            <label for='ilene'>ilene</label>
            <input id='giulio' type='radio' name='toggle' value='giulio'>
            <label for='giulio'>giulio</label>
          </div>
        </div>
        <div id="map" class="photo"></div>
        </article>

    </div>

    <hr>

    <div id="my-footer"></div>

    <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiZGFuc3dpY2siLCJhIjoiY2l1dTUzcmgxMDJ0djJ0b2VhY2sxNXBiMyJ9.25Qs4HNEkHubd4_Awbd8Og';
    var big, zoom, center;
    console.log(window.innerWidth)
    if (window.innerWidth <= 800) {
      center = [ -50, 40]
      zoom = 0;
      big = false;
      document.getElementById("map").style.height = "200px"
    } else {
      center = [ -50, 40]
      zoom = 0.5;
      big = true;
    }
    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v8',
      center: center,
      zoom: zoom,
      // renderWorldCopies: false
    });

    // DEBUG: To show coordinates of mouse click
    // map.on('click', function (e) {console.log(e), console.log("%s,%s", e.lngLat.lat, e.lngLat.lng)});

    var filterPerson = ['!=', ['string', ['get', 'person']], 'placeholder'];
    var filterDate = ['>=', ['number', ['to-number', ['get', 'datef']]], 1989];

    const numSegments = 50
    const percSegmentsHistory = 0.4

    // A simple line from origin to destination.
    var route = {
      "type": "FeatureCollection",
      "features": [{
        "type": "Feature",
        "geometry": {
          "type": "LineString",
          "coordinates": []
        },
        "properties": {
          "person": "giulio"
        }
      },
      {
        "type": "Feature",
        "geometry": {
          "type": "LineString",
          "coordinates": []
        },
        "properties": {
          "person": "ilene"
        }
      }]
    };

    function computeTravel(data)
    {
      var travel = {'coordinates': [], 'dates': [], 'distance': [], 'totdistance': [], 'step': []}
      var trip = {
        "type": "FeatureCollection",
        "features": [{
          "type": "Feature",
          "geometry": {
            "type": "LineString",
            "coordinates": []
          }
        }]
      };

      for (var i = 0; i < data.length - 1; i++)
      {
        var delta = data[i + 1].datef - data[i].datef
        if (delta <= 0) continue

        // Draw an arc between the origin and destination of the two points
        trip.features[0].geometry.coordinates = [data[i].coordinates, data[i+1].coordinates]
        var lineDistance = turf.lineDistance(trip.features[0], 'kilometers');
        const segmentLength = lineDistance / numSegments
        // const numSegments = lineDistance / segmentLength;
        const stepDate = delta / numSegments;
        // TODO: maybe the segment does not contain the end
        for (var j = 0; j <= numSegments; j ++) {
          travel.step.push(j)
          travel.dates.push(data[i].datef + stepDate * j)
          travel.distance.push(segmentLength * j)
          travel.totdistance.push(lineDistance)
          var segment = turf.along(trip.features[0], j * segmentLength, 'kilometers');
          var coords = segment.geometry.coordinates;
          coords[0] = (coords[0] < -180) ? coords[0] + 360 : coords[0];
          coords[0] = (coords[0] > 180) ? coords[0] - 360 : coords[0];
          coords[1] = (coords[1] < -180) ? coords[1] + 360 : coords[1];
          coords[1] = (coords[1] > 180) ? coords[1] - 360 : coords[1];
          travel.coordinates.push(coords);
        }
      }
      return travel;
    }

    function getTrip(travel, y)
    {
      var x2 = 0
      for (var i in travel.coordinates)
      {
        x2 = +i
        if (travel.dates[i] > y) break
      }
      var x1 = x2 - Math.min(travel.step[x2], percSegmentsHistory * numSegments)
      return travel.coordinates.slice(x1, x2)
    }

    function getTrip2(travel, x2)
    {
      var x1 = x2 - Math.min(travel.step[x2], percSegmentsHistory * numSegments)
      return travel.coordinates.slice(x1, x2)
    }

    function norm(x, y)
    {
      return Math.sqrt((x[0] - y[0]) * (x[0] - y[0]) + (x[1] - y[1]) * (x[1] - y[1]))
    }

    function fixDateLine(route)
    {
      var routeOut = jQuery.extend(true, {}, route);
      for (var i = 0; i < routeOut.features.length; i++)
      {
        var coords = routeOut.features[i].geometry.coordinates
        for (var j = 1; j < coords.length; j++)
        {
          if (norm(coords[j], coords[j - 1]) > 90)
          {
            // TODO: improve coordinate at 180
            var split = jQuery.extend(true, {}, routeOut.features[i]);
            split.geometry.coordinates = routeOut.features[i].geometry.coordinates.slice(j)
            routeOut.features[i].geometry.coordinates = routeOut.features[i].geometry.coordinates.slice(0, j)
            if (coords[j-1][0] > 0) {
              routeOut.features[i].geometry.coordinates[j - 1][0] = 180.
              split.geometry.coordinates[0][0] = -180.
            }
            else {
              routeOut.features[i].geometry.coordinates[j - 1][0] = -180.
              split.geometry.coordinates[0][0] = 180.
            }
            routeOut.features.push(split)
            break
          }
        }
      }
      return routeOut
    }

    $(document).ready(function() {
      $.ajax({
        type: "GET",
        url: './places.csv',
        dataType: "text",
        success: function(csvData) {makeGeoJSON(csvData);}
      });
    });

    var slider = document.getElementById("slider");

    var travel_giulio;
    var travel_ilene;

    function toFixed(value, precision) {
      var power = Math.pow(10, precision || 0);
      return String(Math.round(value * power) / power);
    }

    function getDist(d)
    {
      var str = ''
      if (d < 1000) str += toFixed(d, 0)
      else if (d < 1000000) str += toFixed(d / 1000, 0) + 'K'
      else if (d < 1000000000) str += toFixed(d / 1000000, 2) + 'M'
      else str += toFixed(d, 0)
      str += ' km'
      return str
    }

    function makeGeoJSON(csvData) {
      csv2geojson.csv2geojson(csvData, {
        latfield: 'latitude',
        lonfield: 'longitude',
        delimiter: ','
      }, function(err, data) {

        // Read data
        var data_giulio = []
        var data_ilene = []
        var dates = []
        // Sort by date
        data.features.sort(function(a, b) {return a.properties.datef - b.properties.datef;});
        data.features.forEach(function(f) {dates.push(f.properties.date)})
        dates = dates.sort().filter(function(elem, index, self) { return index == self.indexOf(elem);});
        for (var i in data.features)
        {
          if (data.features[i].properties.person == 'giulio') {data_giulio.push(data.features[i])}
          else if (data.features[i].properties.person == 'ilene') {data_ilene.push(data.features[i])}
        }
        data_giulio.push(jQuery.extend(true, {}, data_giulio[data_giulio.length - 1]))
        data_giulio[data_giulio.length - 1].properties.datef = parseFloat(slider.max)
        data_ilene.push(jQuery.extend(true, {}, data_ilene[data_ilene.length - 1]))
        data_ilene[data_ilene.length - 1].properties.datef = parseFloat(slider.max)

        // Add events to match date
        var g = 0, i = 0;
        for (i in dates)
        {
          if (data_giulio[i].properties.date != dates[i])
          {
            var e = jQuery.extend(true, {}, data_giulio[Math.max(0, i - 1)]);
            e.properties.date = dates[i]
            e.properties.datef = csv2geojson.date2float(dates[i])
            data_giulio.splice(i, 0, e);
          }
          if (data_ilene[i].properties.date != dates[i])
          {
            var e = jQuery.extend(true, {}, data_ilene[Math.max(0, i - 1)]);
            e.properties.date = dates[i]
            e.properties.datef = csv2geojson.date2float(dates[i])
            data_ilene.splice(i, 0, e);
          }
        }

        data.features = []
        data_giulio.forEach(function(f) {data.features.push(f)})
        data_ilene.forEach(function(f) {data.features.push(f)})

        var data_giulio_travel = []
        var data_ilene_travel = []
        data_giulio.forEach(function(f) {var e = {'coordinates': f.geometry.coordinates, 'datef': f.properties.datef, 'name': f.properties.name}; data_giulio_travel.push(e)})
        data_ilene.forEach(function(f) {var e = {'coordinates': f.geometry.coordinates, 'datef': f.properties.datef, 'name': f.properties.name}; data_ilene_travel.push(e)})

        // Compute trajectory
        travel_giulio = computeTravel(data_giulio_travel)
        travel_ilene = computeTravel(data_ilene_travel)

        map.on('load', function () {
          map.addSource('route', {
            "type": "geojson",
            "data": route
          });
          map.addLayer({
            "id": "route",
            "source": "route",
            "type": "line",
            "paint": {
              "line-width": 3,
              "line-opacity": 0.8,
              "line-color":
              ['match', ['get', 'person'],
              "giulio", '#0071FF',
              'ilene', '#CC719B',
              '#AAAAAA']
            }
          });
          map.addSource('data', { type: 'geojson', data: data });
          map.addLayer({
            'id': 'places',
            'type': 'circle',
            'source': 'data',
            'paint': {
              'circle-radius': {
                'base': 5,
                'stops': [[1, 15], [10, 10]]
              },
              'circle-blur': 1,
              'circle-color':
              ['match', ['get', 'person'],
              "giulio", '#0071FF',
              'ilene', '#CC719B',
              '#AAAAAA']
            },
            filter: ['all', filterDate, filterPerson]
          });

          var counter = 0
          while (travel_giulio.dates[counter] < 2014) counter++;
          var dist_giulio = 0, dist_ilene = 0;
          function animate() {
            route.features = route.features.splice(0, 2)
            route.features[0].geometry.coordinates = getTrip2(travel_giulio, counter)
            route.features[1].geometry.coordinates = getTrip2(travel_ilene, counter)
            route = fixDateLine(route)
            map.getSource('route').setData(route);

            dist_giulio += travel_giulio.distance[counter]
            dist_ilene += travel_ilene.distance[counter]
            document.getElementById('giulio-dist').innerText = getDist(dist_giulio);
            document.getElementById('ilene-dist').innerText = getDist(dist_ilene);

            slider.value = travel_giulio.dates[counter]
            slider.dispatchEvent(new Event('input'));

            if ((travel_giulio.distance[counter] == 0 && travel_giulio.totdistance[counter] != 0) || (travel_ilene.distance[counter] == 0 && travel_ilene.totdistance[counter] != 0))
            {
              setTimeout(function() {counter = counter + 1; requestAnimationFrame(animate)}, 500)
            }
            else
            {
              counter = counter + 1;
              if (counter >= travel_giulio.coordinates.length)
              {
                setTimeout(function() {counter = 0; requestAnimationFrame(animate)}, 5000)
              }
              else
              {
                requestAnimationFrame(animate);
              }
            }

          }
          animate()
        })

        slider.addEventListener('input', function(e) {
          var date = parseFloat(e.target.value) + 0.003;
          filterDate = ['<=', ['number', ['to-number', ['get', 'datef']]], date]
          map.setFilter('places', ['all', filterDate, filterPerson]);
          document.getElementById('active-date').innerText = date;
          const history = 0.05
          map.setPaintProperty('places', 'circle-opacity', ['*', 1.5, ['-', 1, ['/', ['-', date, ['number', ['to-number', ['get', 'datef']]]], history]]]);
        });

        document.getElementById('filters').addEventListener('change', function(e) {
          var person = e.target.value;
          if (person === 'both') {
            filterPerson = ['!=', ['string', ['get', 'person']], 'placeholder'];
          } else if (person === 'ilene') {
            filterPerson = ['match', ['get', 'person'], 'ilene', true, false];
          } else if (person === 'giulio') {
            filterPerson = ['match', ['get', 'person'], 'giulio', true, false];
          } else {
            console.log('person %s is not valid' % person);
          }
          map.setFilter('places', ['all', filterDate, filterPerson]);
          map.setFilter('route', filterPerson);
        });

        slider.addEventListener('input', function(e) {
          const y = parseInt(Math.floor(slider.value))
          const m = parseInt(Math.floor((slider.value % 1) * 365 / 31) + 1)
          document.getElementById('active-date').innerText = y + "/" + m;
        });

      });
    }
    </script>
  </body>
</html>

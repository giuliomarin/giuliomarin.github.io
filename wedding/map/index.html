<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <title></title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.47.0/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.47.0/mapbox-gl.css' rel='stylesheet' />
  <script src='csv2geojson.js'></script>
  <style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
  .session { position:relative; margin-left: 10px; margin-right: 10px}
  #slider {width:100%}
  </style>
</head>
<body>

  <div id='map'></div>
  <div class='session' id='sliderbar'>
    <center id='active-date'>1989</center>
    <input id='slider' class='row' type='range' min='1989' max='2020' step='0.05' value='1989' />
  </div>
  <div class='session'>
    <div class='row' id='filters'>
      <input id='both' type='radio' name='toggle' value='both' checked='checked'>
      <label for='both'>both</label>
      <input id='ilene' type='radio' name='toggle' value='ilene'>
      <label for='ilene'>ilene</label>
      <input id='giulio' type='radio' name='toggle' value='giulio'>
      <label for='giulio'>giulio</label>
    </div>
  </div>
  <script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiZGFuc3dpY2siLCJhIjoiY2l1dTUzcmgxMDJ0djJ0b2VhY2sxNXBiMyJ9.25Qs4HNEkHubd4_Awbd8Og';
  var zoom, center;
  if (window.innerWidth <= 800) {
    center = [ -40, 0]
    zoom = 0;
  } else {
    center = [ 0, 30]
    zoom = 1.5;
  }
  var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v8',
    center: center,
    zoom: zoom
  });

  var filterPerson = ['!=', ['string', ['get', 'person']], 'placeholder'];
  var filterDate = ['>=', ['number', ['to-number', ['get', 'date']]], 1989];

  $(document).ready(function() {
    $.ajax({
      type: "GET",
      url: './places.csv',
      dataType: "text",
      success: function(csvData) {makeGeoJSON(csvData);}
    });
  });

  var slider = document.getElementById("slider");

  function makeGeoJSON(csvData) {
    csv2geojson.csv2geojson(csvData, {
      latfield: 'latitude',
      lonfield: 'longitude',
      delimiter: ','
    }, function(err, data) {
      map.on('load', function () {
        map.addSource('data', { type: 'geojson', data: data });
        map.addLayer({
          'id': 'places',
          'type': 'circle',
          'source': 'data',
          'paint': {
            'circle-radius': {
              'base': 5,
              'stops': [[1, 15], [10, 10]]
            },
            'circle-blur': 1,
            'circle-color':
            ['match', ['get', 'person'],
            "giulio", '#0071FF',
            'ilene', '#CC719B',
            '#AAAAAA']
          },
          filter: ['all', filterDate, filterPerson]
        });
      });

      document.getElementById('slider').addEventListener('input', function(e) {
        var date = parseInt(e.target.value);
        filterDate = ['<=', ['number', ['to-number', ['get', 'date']]], date]
        map.setFilter('places', ['all', filterDate, filterPerson]);
        document.getElementById('active-date').innerText = date;
        const history = 5
        map.setPaintProperty('places', 'circle-opacity', ['*', 1.5, ['-', 1, ['/', ['-', parseInt(slider.value), ['number', ['to-number', ['get', 'date']]]], history]]]);
      });

      document.getElementById('filters').addEventListener('change', function(e) {
        var person = e.target.value;
        if (person === 'both') {
          filterPerson = ['!=', ['string', ['get', 'person']], 'placeholder'];
        } else if (person === 'ilene') {
          filterPerson = ['match', ['get', 'person'], 'ilene', true, false];
        } else if (person === 'giulio') {
          filterPerson = ['match', ['get', 'person'], 'giulio', true, false];
        } else {
          console.log('person %s is not valid' % person);
        }
        map.setFilter('places', ['all', filterDate, filterPerson]);
      });

      // Auto update slider
      slider.addEventListener('input', function(e) {
        document.getElementById('active-date').innerText = parseInt(slider.value);
      });

      var interval = setInterval(function() {
        if (slider.value >= slider.max) {
          clearInterval(interval)
          // slider.value = slider.min
        }
        else {
          slider.stepUp();
          slider.dispatchEvent(new Event('input'));}
        }, 10);

        // DEBUG: To show coordinates of mouse click
        map.on('click', function (e) {console.log(e), console.log("%s,%s", e.lngLat.lat, e.lngLat.lng)});
      });
    }

    </script>

  </body>
  </html>

<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <title></title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.47.0/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.47.0/mapbox-gl.css' rel='stylesheet' />
  <script src='csv2geojson.js'></script>
  <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v2.0.0/turf.min.js' charset='utf-8'></script>
  <style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
  .session { position:relative; margin-left: 10px; margin-right: 10px}
  #slider {width:100%}
  </style>
</head>
<body>

  <div id='map'></div>
  <div class='session' id='sliderbar'>
    <center id='active-date'>1989</center>
    <input id='slider' class='row' type='range' min='1989' max='2020' step='0.01' value='1989'/>
  </div>
  <div class='session'>
    <div class='row' id='filters'>
      <input id='both' type='radio' name='toggle' value='both' checked='checked'>
      <label for='both'>both</label>
      <input id='ilene' type='radio' name='toggle' value='ilene'>
      <label for='ilene'>ilene</label>
      <input id='giulio' type='radio' name='toggle' value='giulio'>
      <label for='giulio'>giulio</label>
    </div>
  </div>
  <script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiZGFuc3dpY2siLCJhIjoiY2l1dTUzcmgxMDJ0djJ0b2VhY2sxNXBiMyJ9.25Qs4HNEkHubd4_Awbd8Og';
  var zoom, center;
  if (window.innerWidth <= 800) {
    center = [ -40, 0]
    zoom = 0;
  } else {
    center = [ 0, 30]
    zoom = 1.5;
  }
  var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v8',
    center: center,
    zoom: zoom,
    // renderWorldCopies: false
  });

  // DEBUG: To show coordinates of mouse click
  // map.on('click', function (e) {console.log(e), console.log("%s,%s", e.lngLat.lat, e.lngLat.lng)});

  var filterPerson = ['!=', ['string', ['get', 'person']], 'placeholder'];
  var filterDate = ['>=', ['number', ['to-number', ['get', 'date']]], 1989];

  // const segmentLength = 10 // kilometers
  const numSegments = 50
  const percSegmentsHistory = 0.4

  // A simple line from origin to destination.
  var route = {
    "type": "FeatureCollection",
    "features": [{
      "type": "Feature",
      "geometry": {
        "type": "LineString",
        "coordinates": []
      },
      "properties": {
        "person": "giulio"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "LineString",
        "coordinates": []
      },
      "properties": {
        "person": "ilene"
      }
    }]
  };

  function computeTravel(data)
  {
    var travel = {'coordinates': [], 'dates': [], 'distance': [], 'totdistance': [], 'step': []}
    var trip = {
      "type": "FeatureCollection",
      "features": [{
        "type": "Feature",
        "geometry": {
          "type": "LineString",
          "coordinates": []
        }
      }]
    };

    for (var i = 0; i < data.length - 1; i++)
    {
      var delta = data[i + 1].date - data[i].date
      if (delta <= 0) continue

      // Draw an arc between the origin and destination of the two points
      trip.features[0].geometry.coordinates = [data[i].coordinates, data[i+1].coordinates]
      var lineDistance = turf.lineDistance(trip.features[0], 'kilometers');
      const segmentLength = lineDistance / numSegments
      // const numSegments = lineDistance / segmentLength;
      const stepDate = delta / numSegments;
      // TODO: maybe the segment does not contain the end
      for (var j = 0; j <= numSegments; j ++) {
        travel.step.push(j)
        travel.dates.push(data[i].date + stepDate * j)
        travel.distance.push(segmentLength * j)
        travel.totdistance.push(lineDistance)
        var segment = turf.along(trip.features[0], j * segmentLength, 'kilometers');
        var coords = segment.geometry.coordinates;
        coords[0] = (coords[0] < -180) ? coords[0] + 360 : coords[0];
        coords[0] = (coords[0] > 180) ? coords[0] - 360 : coords[0];
        coords[1] = (coords[1] < -180) ? coords[1] + 360 : coords[1];
        coords[1] = (coords[1] > 180) ? coords[1] - 360 : coords[1];
        travel.coordinates.push(coords);
      }
    }
    return travel;
  }

  function getTrip(travel, y)
  {
    var x2 = 0
    for (var i in travel.coordinates)
    {
      x2 = +i
      if (travel.dates[i] > y) break
    }
    var x1 = x2 - Math.min(travel.step[x2], percSegmentsHistory * numSegments)
    return travel.coordinates.slice(x1, x2)
  }

  function getTrip2(travel, x2)
  {
    var x1 = x2 - Math.min(travel.step[x2], percSegmentsHistory * numSegments)
    return travel.coordinates.slice(x1, x2)
  }

  function norm(x, y)
  {
    return Math.sqrt((x[0] - y[0]) * (x[0] - y[0]) + (x[1] - y[1]) * (x[1] - y[1]))
  }

  function fixDateLine(route)
  {
    var routeOut = jQuery.extend(true, {}, route);
    for (var i = 0; i < routeOut.features.length; i++)
    {
      var coords = routeOut.features[i].geometry.coordinates
      for (var j = 1; j < coords.length; j++)
      {
        if (norm(coords[j], coords[j - 1]) > 90)
        {
          // TODO: add coordinate at 180
          var split = jQuery.extend(true, {}, routeOut.features[i]);
          split.geometry.coordinates = routeOut.features[i].geometry.coordinates.slice(j)
          routeOut.features[i].geometry.coordinates = routeOut.features[i].geometry.coordinates.slice(0, j)
          routeOut.features.push(split)
          break
        }
      }
    }
    return routeOut
  }

  $(document).ready(function() {
    $.ajax({
      type: "GET",
      url: './places.csv',
      dataType: "text",
      success: function(csvData) {makeGeoJSON(csvData);}
    });
  });

  var slider = document.getElementById("slider");

  var travel_giulio;
  var travel_ilene;

  function makeGeoJSON(csvData) {
    csv2geojson.csv2geojson(csvData, {
      latfield: 'latitude',
      lonfield: 'longitude',
      delimiter: ','
    }, function(err, data) {

      // Read data
      var data_giulio = []
      var data_ilene = []
      for (var i in data.features)
      {
        var e = {'coordinates': data.features[i].geometry.coordinates, 'date': parseFloat(data.features[i].properties.date), 'name': data.features[i].properties.name}
        if (data.features[i].properties.person == 'giulio') {data_giulio.push(e)}
        else if (data.features[i].properties.person == 'ilene') {data_ilene.push(e)}
      }
      data_giulio.push(jQuery.extend(true, {}, data_giulio[data_giulio.length - 1]))
      data_giulio[data_giulio.length - 1].date = parseFloat(slider.max)
      data_ilene.push(jQuery.extend(true, {}, data_ilene[data_ilene.length - 1]))
      data_ilene[data_ilene.length - 1].date = parseFloat(slider.max)

      // Sort by date
      data_giulio.sort(function(a, b) {return a.date - b.date;});
      data_ilene.sort(function(a, b) {return a.date - b.date;});

      // List of dates
      var dates = []
      for (i in data_giulio) dates.push(data_giulio[i].date)
      for (i in data_ilene) dates.push(data_ilene[i].date)
      dates = dates.sort().filter(function(elem, index, self) { return index == self.indexOf(elem);});

      // Add events to match date
      var g = 0, i = 0;
      for (i in dates)
      {
        if (data_giulio[i].date != dates[i])
        {
          var e = jQuery.extend(true, {}, data_giulio[i - 1]);
          e.date = dates[i]
          data_giulio.splice(i, 0, e);
        }
        if (data_ilene[i].date != dates[i])
        {
          var e = jQuery.extend(true, {}, data_ilene[i - 1]);
          e.date = dates[i]
          data_ilene.splice(i, 0, e);
        }
      }

      // Compute trajectory
      travel_giulio = computeTravel(data_giulio)
      travel_ilene = computeTravel(data_ilene)

      map.on('load', function () {
        map.addSource('route', {
          "type": "geojson",
          "data": route
        });
        map.addLayer({
          "id": "route",
          "source": "route",
          "type": "line",
          "paint": {
            "line-width": 3,
            "line-opacity": 0.8,
            "line-color":
            ['match', ['get', 'person'],
            "giulio", '#0071FF',
            'ilene', '#CC719B',
            '#AAAAAA']
          }
        });
        map.addSource('data', { type: 'geojson', data: data });
        map.addLayer({
          'id': 'places',
          'type': 'circle',
          'source': 'data',
          'paint': {
            'circle-radius': {
              'base': 5,
              'stops': [[1, 15], [10, 10]]
            },
            'circle-blur': 1,
            'circle-color':
            ['match', ['get', 'person'],
            "giulio", '#0071FF',
            'ilene', '#CC719B',
            '#AAAAAA']
          },
          filter: ['all', filterDate, filterPerson]
        });

        var counter = 0
        var dist_giulio = 0, dist_ilene = 0;
        function animate() {
          const y = parseFloat(slider.value)
          route.features = route.features.splice(0, 2)
          route.features[0].geometry.coordinates = getTrip2(travel_giulio, counter)
          route.features[1].geometry.coordinates = getTrip2(travel_ilene, counter)
          route = fixDateLine(route)
          map.getSource('route').setData(route);

          dist_giulio += travel_giulio.distance[counter]
          dist_ilene += travel_ilene.distance[counter]
          // TODO: show distance

          slider.value = travel_giulio.dates[counter]
          slider.dispatchEvent(new Event('input'));

          if ((travel_giulio.distance[counter] == 0 && travel_giulio.totdistance[counter] != 0) || (travel_ilene.distance[counter] == 0 && travel_ilene.totdistance[counter] != 0))
          {
            setTimeout(function() {counter = counter + 1; requestAnimationFrame(animate)}, 1000)
          }
          else
          {
            counter = counter + 1;
            if (counter >= travel_giulio.coordinates.length)
            {
              setTimeout(function() {counter = 0; requestAnimationFrame(animate)}, 5000)
            }
            else
            {
              requestAnimationFrame(animate);
            }
          }

        }
        animate()
      })

      slider.addEventListener('input', function(e) {
        var date = parseFloat(e.target.value);
        filterDate = ['<=', ['number', ['to-number', ['get', 'date']]], date]
        map.setFilter('places', ['all', filterDate, filterPerson]);
        document.getElementById('active-date').innerText = date;
        const history = 2
        map.setPaintProperty('places', 'circle-opacity', ['*', 1.5, ['-', 1, ['/', ['-', parseFloat(slider.value), ['number', ['to-number', ['get', 'date']]]], history]]]);
      });

      document.getElementById('filters').addEventListener('change', function(e) {
        var person = e.target.value;
        if (person === 'both') {
          filterPerson = ['!=', ['string', ['get', 'person']], 'placeholder'];
        } else if (person === 'ilene') {
          filterPerson = ['match', ['get', 'person'], 'ilene', true, false];
        } else if (person === 'giulio') {
          filterPerson = ['match', ['get', 'person'], 'giulio', true, false];
        } else {
          console.log('person %s is not valid' % person);
        }
        map.setFilter('places', ['all', filterDate, filterPerson]);
        map.setFilter('route', filterPerson);
      });

      slider.addEventListener('input', function(e) {
        document.getElementById('active-date').innerText = parseInt(slider.value);
      });

    });
  }
</script>
</body>
</html>

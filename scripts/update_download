# To setup auto refreshing on mac
# cp com.giuliomarin.website.plist $HOME/Library/LaunchAgents/
# launchctl load $HOME/Library/LaunchAgents/com.giuliomarin.website.plist

# check connectivity
ping -c1 www.google.com
if [ "$?" != 0 ]; then
  echo "No internet connection"
  exit
fi

# get main folder
# MAIN_DIR=/GitHub/giuliomarin.github.io
MAIN_DIR=`dirname "$0"`/..
pushd $MAIN_DIR

# rebase commits
touch $MAIN_DIR/tmpfile
git add $MAIN_DIR/tmpfile
git stash
git pull
idlist=`git log --format=format:"%h|%s" | awk -F\| '$2~/\[\*\*generated\*\*\]/ {printf("%s ", $1)}'`
echo "List of commits to rebase: $idlist"
for id in $idlist;
do
  git rebase -p --onto $id^ $id
done
git stash pop
rm $MAIN_DIR/tmpfile

# download web pages
unamestr=`uname`
if [[ "$unamestr" == 'Darwin' ]]; then
  COMMAND="curl"
else
  COMMAND="wget -O -"
fi

$COMMAND "https://scholar.google.com/citations?user=t9UpeEAAAAAJ&hl=en" > $MAIN_DIR/publications/googlescholar_giuliomarin.html
$COMMAND "https://www.runtastic.com/en/users/07b82bdf-b0df-9b46-97f1-0e6d19b40d88/statistics" > $MAIN_DIR/extra/runtastic_giuliomarin.html
echo "Updated on `date`" > $MAIN_DIR/scripts/log_downloaded.txt

# commit generated files
git reset
git add $MAIN_DIR/publications/googlescholar_giuliomarin.html
git add $MAIN_DIR/extra/runtastic_giuliomarin.html
git add $MAIN_DIR/scripts/log_downloaded.txt
git commit -m "[**generated**] updated downloaded pages"
git push -f

popd

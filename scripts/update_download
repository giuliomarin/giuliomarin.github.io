#!/bin/bash
# To setup auto refreshing on mac
# cp com.giuliomarin.website.plist $HOME/Library/LaunchAgents/
# launchctl load $HOME/Library/LaunchAgents/com.giuliomarin.website.plist
## (to stop) launchctl unload $HOME/Library/LaunchAgents/com.giuliomarin.website.plist

# check connectivity
ping -c1 www.google.com > /dev/null
if [ "$?" != 0 ]; then
  echo "No internet connection"
  exit 0
else
  echo "Connected to internet"
fi

# get main folder
pushd `dirname $0`/.. > /dev/null

# rebase commits
touch tmpfile
git add tmpfile
git stash
git fetch
git reset --hard origin/master
idlist=`git log --format=format:"%h|%s" | awk -F\| '$2~/\[\*\*generated\*\*\]/ {printf("%s ", $1)}'`
echo "List of commits to rebase: $idlist"
for id in $idlist;
do
  git rebase -p --onto $id^ $id
done
git stash pop
git reset
rm tmpfile

# download web pages
if [[ "`uname`" == 'Darwin' ]]; then
  COMMAND="curl"
else
  COMMAND="wget -O -"
fi

$COMMAND "https://scholar.google.com/citations?user=t9UpeEAAAAAJ&hl=en" > publications/googlescholar_giuliomarin.html
$COMMAND "https://www.runtastic.com/en/users/07b82bdf-b0df-9b46-97f1-0e6d19b40d88/statistics" > extra/runtastic_giuliomarin.html
echo "Updated on `date`" > scripts/log_downloaded.txt

# commit generated files
git add publications/googlescholar_giuliomarin.html
git add extra/runtastic_giuliomarin.html
git add scripts/log_downloaded.txt
git commit -m "[**generated**] updated downloaded pages"
git push -f

popd > /dev/null
